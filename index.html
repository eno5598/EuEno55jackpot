<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Eurojackpot-Systemtool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- JSZip f√ºr ZIP-Entpacken -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"
            integrity="sha512-AF/nk7mHOF1X6BPZRrjZMclQ5pS4VF63B6kmGij4XM2n0Z0oe8IiZzoqK2D8Ha17nuq+wx2mzhLSocO0V+QK3Q=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root {
            --bg: #f5f7fb;
            --bg-alt: #ffffff;
            --accent: #00528c;
            --accent-soft: #e0edf8;
            --hot: #e74c3c;
            --cold: #3498db;
            --gap: #8e44ad;
            --text: #222;
            --muted: #777;
            --border: #dde3f0;
            --shadow: 0 4px 12px rgba(0,0,0,0.06);
            --radius: 10px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        header {
            background: var(--accent);
            color: #fff;
            padding: 1.2rem 1.8rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: .6rem;
        }

        header h1 span.logo {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: .2rem .55rem;
            font-weight: 700;
            letter-spacing: .03em;
        }

        main {
            padding: 1.5rem 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .grid { grid-template-columns: minmax(0, 1fr); }
        }

        .card {
            background: var(--bg-alt);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.0rem 1.2rem 1.2rem;
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: .7rem;
            gap: .75rem;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: .45rem;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
            font-size: .8rem;
            padding: .1rem .45rem;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent);
        }

        .status {
            background: #fff7e0;
            border-radius: var(--radius);
            border: 1px solid #f3df9c;
            padding: .7rem .8rem;
            font-size: .9rem;
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: .9rem;
        }

        .status.error {
            background: #ffecec;
            border-color: #f3a3a3;
        }

        .status span.icon { font-size: 1.2rem; }

        label {
            font-size: .85rem;
            color: var(--muted);
            display: block;
            margin-bottom: .15rem;
        }

        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: .35rem .45rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: .9rem;
            font-family: inherit;
            background: #fff;
        }

        textarea {
            resize: vertical;
            min-height: 70px;
        }

        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0,82,140,0.15);
        }

        .row {
            display: flex;
            gap: .7rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .row > div {
            flex: 1;
            min-width: 120px;
        }

        .btn {
            border-radius: 999px;
            border: none;
            padding: .45rem .9rem;
            font-size: .9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }

        .btn-soft {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .btn-ghost {
            background: transparent;
            color: var(--muted);
        }

        .btn:disabled {
            opacity: .55;
            cursor: not-allowed;
        }

        .badge {
            border-radius: 999px;
            padding: .1rem .5rem;
            font-size: .75rem;
            background: #f0f3fa;
            color: var(--muted);
        }

        .stat-row {
            display: flex;
            flex-wrap: wrap;
            gap: .7rem;
            font-size: .9rem;
            color: var(--muted);
        }

        .stat-row span strong {
            color: var(--text);
        }

        .pill-row {
            display: flex;
            flex-wrap: wrap;
            gap: .3rem;
            margin-top: .25rem;
        }

        .pill {
            border-radius: 999px;
            padding: .1rem .45rem;
            font-size: .82rem;
            background: #f3f6fc;
            border: 1px solid #e0e5f5;
            display: inline-flex;
            align-items: center;
            gap: .25rem;
        }

        .pill.hot { border-color: rgba(231,76,60,0.3); background: rgba(231,76,60,0.05); }
        .pill.cold { border-color: rgba(52,152,219,0.35); background: rgba(52,152,219,0.05); }
        .pill.gap { border-color: rgba(142,68,173,0.35); background: rgba(142,68,173,0.05); }

        .pill span.num {
            font-weight: 600;
        }

        .pill small {
            color: var(--muted);
            font-size: .75rem;
        }

        .subgrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: .8rem;
        }

        .system-block {
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: .7rem .75rem .75rem;
            background: #fafbff;
            position: relative;
        }

        .system-block-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .4rem;
            margin-bottom: .45rem;
        }

        .system-block-header strong {
            font-size: .9rem;
        }

        .system-block-header button {
            border-radius: 999px;
            border: none;
            background: transparent;
            color: #c0392b;
            cursor: pointer;
            padding: .15rem .3rem;
        }

        .systems-output {
            margin-top: .6rem;
            max-height: 260px;
            overflow: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #fcfdff;
            font-size: .82rem;
        }

        .systems-output table {
            border-collapse: collapse;
            width: 100%;
        }

        .systems-output th,
        .systems-output td {
            padding: .35rem .45rem;
            border-bottom: 1px solid #eef1fa;
            text-align: left;
        }

        .systems-output th {
            background: #f4f6fd;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .systems-output tr:nth-child(even) td {
            background: #fafbff;
        }

        .tag-main { color: var(--accent); font-weight: 600; }
        .tag-euro { color: #f39c12; font-weight: 600; }

        .totals {
            margin-top: .4rem;
            font-size: .88rem;
            color: var(--muted);
        }

        .totals strong {
            color: var(--text);
        }

        .small-note {
            font-size: .78rem;
            color: var(--muted);
            margin-top: .35rem;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: .5rem;
            flex-wrap: wrap;
        }

        .hot-title { color: var(--hot); }
        .cold-title { color: var(--cold); }
        .gap-title { color: var(--gap); }

        .section-title {
            font-weight: 600;
            font-size: .95rem;
            margin-top: .4rem;
            margin-bottom: .2rem;
        }

        .number-input-inline {
            width: 90px;
        }

        .highlight {
            background: #fffce6;
        }
    </style>
</head>
<body>

<header>
    <h1>
        <span class="logo">EJ</span>
        Eurojackpot-Systemtool
    </h1>
</header>

<main>
    <div id="status" class="status">
        <span class="icon">‚è≥</span>
        <span>Archiv wird geladen ‚Ä¶</span>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>üìö Archiv & Auswertung</h2>
            <span class="badge" id="archiveSummary">‚Äì</span>
        </div>
        <div class="stat-row" style="margin-bottom:.5rem;">
            <span>Ziehungen: <strong id="drawCount">‚Äì</strong></span>
            <span>Letzte Ziehung: <strong id="lastDraw">‚Äì</strong></span>
        </div>

        <div class="row" style="margin-bottom:.4rem;">
            <div>
                <label for="scopeMode">Analysebereich</label>
                <select id="scopeMode">
                    <option value="all">Ganzes Archiv</option>
                    <option value="last">Nur letzte n Ziehungen</option>
                </select>
            </div>
            <div>
                <label for="scopeLast">Anzahl letzter Ziehungen</label>
                <input id="scopeLast" type="number" min="10" max="9999" value="200">
            </div>
            <div>
                <button id="recalcBtn" class="btn btn-soft" disabled>
                    üîÑ Analyse aktualisieren
                </button>
            </div>
        </div>
        <p class="small-note">
            Hinweis: Dieses Tool analysiert nur Vergangenheitsdaten (H√§ufigkeiten, Abst√§nde, Muster).
            Es gibt <strong>keine Gewinn-Garantie</strong> und keine Vorhersagen.
        </p>
    </div>

    <div class="grid">
        <section class="card">
            <div class="card-header">
                <h2>üî•üßä Hot & Cold ‚Äì Hauptzahlen</h2>
            </div>
            <div class="subgrid">
                <div>
                    <div class="section-title hot-title">üî• Hei√üeste Zahlen</div>
                    <div id="hotMain" class="pill-row"></div>
                </div>
                <div>
                    <div class="section-title cold-title">üßä K√§lteste Zahlen</div>
                    <div id="coldMain" class="pill-row"></div>
                </div>
                <div>
                    <div class="section-title gap-title">‚è≥ Gr√∂√üte Abst√§nde</div>
                    <div id="gapMain" class="pill-row"></div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>üî•üßä Hot & Cold ‚Äì Eurozahlen</h2>
            </div>
            <div class="subgrid">
                <div>
                    <div class="section-title hot-title">üî• Hei√üeste Eurozahlen</div>
                    <div id="hotEuro" class="pill-row"></div>
                </div>
                <div>
                    <div class="section-title cold-title">üßä K√§lteste Eurozahlen</div>
                    <div id="coldEuro" class="pill-row"></div>
                </div>
                <div>
                    <div class="section-title gap-title">‚è≥ Gr√∂√üte Abst√§nde</div>
                    <div id="gapEuro" class="pill-row"></div>
                </div>
            </div>
        </section>
    </div>

    <section class="card">
        <div class="card-header">
            <h2>üéüÔ∏è System-Generator</h2>
            <button id="addBlockBtn" class="btn btn-soft" disabled>‚ûï Systemblock hinzuf√ºgen</button>
        </div>

        <p class="small-note">
            Erzeuge beliebig viele Systemtipps:
            z.&nbsp;B. <strong>1√ó 7/2</strong>, <strong>1√ó 8/2</strong>, <strong>3√ó 6/3</strong>.
            Spieleanzahl und Einsatz werden automatisch berechnet.
        </p>

        <div id="systemBlocks" class="subgrid"></div>

        <div class="flex-between" style="margin-top:.7rem;">
            <button id="generateBtn" class="btn btn-primary" disabled>
                ü§ñ Systemtipps generieren
            </button>
            <div class="totals">
                Gesamtspiele: <strong id="totalGames">0</strong>,
                Gesamteinsatz: <strong id="totalPrice">0,00 ‚Ç¨</strong>
            </div>
        </div>

        <div class="systems-output" id="systemsOutput" style="display:none;margin-top:.7rem;"></div>

        <p class="small-note">
            Profile:
            üî• Hot-Fokus (h√§ufiger gezogen),
            üßä Cold-Fokus (seltener gezogen),
            ‚è≥ Gap-Fokus (lange nicht gezogen),
            üéõÔ∏è Mix (ausgewogener Mix). Keine Garantie auf Treffer.
        </p>
    </section>

    <section class="card">
        <div class="card-header">
            <h2>üîç Analyse eines eigenen Tipps</h2>
        </div>
        <p style="font-size:.85rem;margin-bottom:.4rem;">
            Gib einen Tipp im Format ein, z.&nbsp;B. <code>5 12 23 34 45 | 2 10</code>.
            Du kannst auch mehr als 5 Hauptzahlen und 2 Eurozahlen angeben, um einen Systemtipp zu analysieren.
        </p>
        <div class="row">
            <div style="flex:2;">
                <label for="analyzeInput">Tipp (Hauptzahlen | Eurozahlen)</label>
                <input id="analyzeInput" type="text" placeholder="z. B. 5 12 23 34 45 48 | 2 10 11">
            </div>
            <div style="flex:0 0 auto;">
                <button id="analyzeBtn" class="btn btn-soft" disabled>üîç Tipp analysieren</button>
            </div>
        </div>
        <div id="analyzeResult" style="margin-top:.6rem;font-size:.86rem;"></div>
    </section>
</main>

<script>
    // ----------------------------
    // Hilfsfunktionen
    // ----------------------------
    function combinations(n, k) {
        if (k < 0 || k > n) return 0;
        if (k === 0 || k === n) return 1;
        let res = 1;
        for (let i = 1; i <= k; i++) {
            res = res * (n - (k - i)) / i;
        }
        return res;
    }

    function formatEuro(value) {
        return value.toLocaleString("de-DE", {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " ‚Ç¨";
    }

    function parseTipString(str) {
        if (!str) return null;
        const parts = str.split("|");
        if (parts.length !== 2) return null;
        const main = Array.from(new Set(parts[0].trim().split(/\s+/).map(x => parseInt(x, 10)).filter(n => !isNaN(n))));
        const euro = Array.from(new Set(parts[1].trim().split(/\s+/).map(x => parseInt(x, 10)).filter(n => !isNaN(n))));
        if (!main.length || !euro.length) return null;
        return {main: main.sort((a,b)=>a-b), euro: euro.sort((a,b)=>a-b)};
    }

    // erlaubte Systemkombinationen (37 Varianten laut Brosch√ºre)
    function getAllowedEuroCounts(mainCount) {
        if (mainCount === 5 || mainCount === 6) return [2,3,4,5,6,7,8,9,10,11,12];
        if (mainCount === 7) return [2,3,4,5,6,7,8];
        if (mainCount === 8) return [2,3,4,5];
        if (mainCount === 9) return [2,3];
        if (mainCount === 10 || mainCount === 11) return [2];
        return [];
    }

    // ----------------------------
    // Archiv laden
    // ----------------------------
    const ARCHIVE_URL = "https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip";
    const PROXIES = [
        url => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url),
        url => "https://cors.isomorphic-git.org/" + url,
        url => "https://corsproxy.io/?" + encodeURIComponent(url)
    ];

    const state = {
        draws: [],
        filteredDraws: [],
        stats: null,
        systems: []
    };

    const els = {
        status: document.getElementById("status"),
        drawCount: document.getElementById("drawCount"),
        lastDraw: document.getElementById("lastDraw"),
        archiveSummary: document.getElementById("archiveSummary"),
        scopeMode: document.getElementById("scopeMode"),
        scopeLast: document.getElementById("scopeLast"),
        recalcBtn: document.getElementById("recalcBtn"),
        addBlockBtn: document.getElementById("addBlockBtn"),
        generateBtn: document.getElementById("generateBtn"),
        totalGames: document.getElementById("totalGames"),
        totalPrice: document.getElementById("totalPrice"),
        systemsOutput: document.getElementById("systemsOutput"),
        systemBlocks: document.getElementById("systemBlocks"),
        hotMain: document.getElementById("hotMain"),
        coldMain: document.getElementById("coldMain"),
        gapMain: document.getElementById("gapMain"),
        hotEuro: document.getElementById("hotEuro"),
        coldEuro: document.getElementById("coldEuro"),
        gapEuro: document.getElementById("gapEuro"),
        analyzeInput: document.getElementById("analyzeInput"),
        analyzeBtn: document.getElementById("analyzeBtn"),
        analyzeResult: document.getElementById("analyzeResult")
    };

    async function fetchArchiveZip() {
        // Proxy-Versuche
        for (const proxy of PROXIES) {
            const proxied = proxy(ARCHIVE_URL);
            try {
                const res = await fetch(proxied);
                if (res.ok) {
                    els.status.innerHTML = '<span class="icon">‚òÅÔ∏è</span><span>Archiv √ºber Proxy geladen.</span>';
                    return await res.arrayBuffer();
                }
            } catch (e) {
                // ignorieren und n√§chsten Proxy versuchen
            }
        }
        // Lokale ZIP-Datei
        try {
            const localRes = await fetch("archiv_eurojackpot.zip");
            if (localRes.ok) {
                els.status.innerHTML = '<span class="icon">üì¶</span><span>Lokale Datei ‚Äûarchiv_eurojackpot.zip‚Äú geladen.</span>';
                return await localRes.arrayBuffer();
            }
        } catch (e) {
            // ignorieren
        }
        return null;
    }

    async function loadArchive() {
        try {
            els.status.innerHTML = '<span class="icon">‚è≥</span><span>Archiv wird geladen ‚Ä¶</span>';

            let text = null;
            const zipBuf = await fetchArchiveZip();
            if (zipBuf) {
                const zip = await JSZip.loadAsync(zipBuf);
                const file = zip.file(/eurojackpot\.txt/i)[0];
                if (file) {
                    text = await file.async("string");
                }
            }

            // Fallback: lokale eurojackpot.txt
            if (!text) {
                try {
                    const res = await fetch("eurojackpot.txt");
                    if (res.ok) {
                        text = await res.text();
                        els.status.innerHTML = '<span class="icon">üìÑ</span><span>Lokale Datei ‚Äûeurojackpot.txt‚Äú geladen.</span>';
                    }
                } catch (e) { /* ignorieren */ }
            }

            if (!text) {
                els.status.classList.add("error");
                els.status.innerHTML = '<span class="icon">‚ö†Ô∏è</span><span>Archiv konnte nicht geladen werden. Bitte ZIP- oder TXT-Datei im selben Ordner ablegen.</span>';
                return;
            }

            parseArchive(text);
            updateScope();
            computeStats();
            renderStats();
            renderHotCold();
            enableUI();
        } catch (err) {
            console.error(err);
            els.status.classList.add("error");
            els.status.innerHTML = '<span class="icon">‚ö†Ô∏è</span><span>Fehler beim Laden/Verarbeiten des Archivs.</span>';
        }
    }

    function parseArchive(text) {
        const lines = text.trim().split(/\r?\n/);
        const draws = [];
        for (let i = 1; i < lines.length; i++) { // erste Zeile = Header
            const parts = lines[i].trim().split(/\s+/);
            if (parts.length < 9) continue;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            if (isNaN(day) || isNaN(month) || isNaN(year)) continue;
            const main = parts.slice(3, 8).map(x => parseInt(x, 10)).filter(n => !isNaN(n));
            const euro = parts.slice(8, 10).map(x => parseInt(x, 10)).filter(n => !isNaN(n));
            if (main.length !== 5 || euro.length !== 2) continue;
            const dateStr = `${String(day).padStart(2,"0")}.${String(month).padStart(2,"0")}.${year}`;
            draws.push({date: dateStr, main, euro});
        }
        state.draws = draws;
        els.drawCount.textContent = draws.length.toString();
        if (draws.length > 0) {
            els.lastDraw.textContent = draws[draws.length - 1].date;
            els.archiveSummary.textContent = `Archiv: ${draws.length} Ziehungen seit ${draws[0].date}`;
        } else {
            els.archiveSummary.textContent = "Archiv leer?";
        }
    }

    function updateScope() {
        if (!state.draws.length) return;
        const mode = els.scopeMode.value;
        const n = parseInt(els.scopeLast.value, 10) || 0;
        if (mode === "last" && n > 0) {
            state.filteredDraws = state.draws.slice(-Math.min(n, state.draws.length));
        } else {
            state.filteredDraws = state.draws.slice();
        }
    }

    function computeStats() {
        const draws = state.filteredDraws;
        const mainFreq = Array(51).fill(0);
        const euroFreq = Array(13).fill(0);
        const mainLast = Array(51).fill(null);
        const euroLast = Array(13).fill(null);

        const total = draws.length;
        for (let i = 0; i < total; i++) {
            const d = draws[i];
            d.main.forEach(num => {
                mainFreq[num]++;
                mainLast[num] = total - i; // Abstand zur letzten Ziehung
            });
            d.euro.forEach(num => {
                euroFreq[num]++;
                euroLast[num] = total - i;
            });
        }

        // nie gezogene Zahlen: Gap = total + 1
        for (let n = 1; n <= 50; n++) {
            if (mainLast[n] === null) mainLast[n] = total + 1;
        }
        for (let n = 1; n <= 12; n++) {
            if (euroLast[n] === null) euroLast[n] = total + 1;
        }

        state.stats = {
            total,
            mainFreq,
            euroFreq,
            mainLast,
            euroLast
        };
    }

    function renderHotCold() {
        const s = state.stats;
        if (!s) return;

        function buildPills(container, values, last, count, type) {
            container.innerHTML = "";
            const entries = [];
            for (let n = 1; n < values.length; n++) {
                entries.push({n, freq: values[n], gap: last[n]});
            }
            const nonZero = entries.filter(e => e.freq > 0);
            const maxFreq = nonZero.length ? Math.max(...nonZero.map(e => e.freq)) : 1;
            const maxGap = Math.max(...entries.map(e => e.gap));

            const hot = [...entries].sort((a,b)=>b.freq - a.freq).slice(0, count);
            const cold = [...entries].sort((a,b)=>a.freq - b.freq || b.gap - a.gap).slice(0, count);
            const gaps = [...entries].sort((a,b)=>b.gap - a.gap).slice(0, count);

            function createPill(e, cls) {
                const div = document.createElement("div");
                div.className = `pill ${cls}`;
                const strength = e.freq === 0 ? 0 : (e.freq / maxFreq);
                const gapRel = e.gap / maxGap;
                div.title = `H√§ufigkeit: ${e.freq}x ¬∑ Abstand: ${e.gap} Ziehungen`;
                div.innerHTML = `<span class="num">${e.n}</span><small>${e.freq}√ó ¬∑ ‚è≥${e.gap}</small>`;
                return div;
            }

            const hotC = (type === "main") ? els.hotMain : els.hotEuro;
            const coldC = (type === "main") ? els.coldMain : els.coldEuro;
            const gapC = (type === "main") ? els.gapMain : els.gapEuro;

            hotC.innerHTML = "";
            coldC.innerHTML = "";
            gapC.innerHTML = "";

            hot.forEach(e => hotC.appendChild(createPill(e, "hot")));
            cold.forEach(e => coldC.appendChild(createPill(e, "cold")));
            gaps.forEach(e => gapC.appendChild(createPill(e, "gap")));
        }

        buildPills(null, s.mainFreq, s.mainLast, 10, "main");
        buildPills(null, s.euroFreq, s.euroLast, 6, "euro");
    }

    function renderStats() {
        // bereits in computeStats & renderHotCold abgedeckt
    }

    function enableUI() {
        els.recalcBtn.disabled = false;
        els.addBlockBtn.disabled = false;
        els.generateBtn.disabled = false;
        els.analyzeBtn.disabled = false;

        // Standardm√§√üig einen Block hinzuf√ºgen
        if (!state.systems.length) {
            addSystemBlock(6,3,2,"mix");
        }

        els.status.innerHTML = '<span class="icon">‚úÖ</span><span>Archiv geladen. Analyse bereit.</span>';
    }

    // ----------------------------
    // Systembl√∂cke
    // ----------------------------
    let blockCounter = 0;

    function addSystemBlock(mainCount=6, euroCount=3, variants=1, profile="mix") {
        const blockId = ++blockCounter;
        const wrapper = document.createElement("div");
        wrapper.className = "system-block";
        wrapper.dataset.blockId = blockId.toString();

        const header = document.createElement("div");
        header.className = "system-block-header";
        header.innerHTML = `<strong>Block #${blockId}</strong>`;
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.innerHTML = "üóëÔ∏è";
        removeBtn.title = "Block entfernen";
        removeBtn.addEventListener("click", () => {
            wrapper.remove();
            updateTotals();
        });
        header.appendChild(removeBtn);
        wrapper.appendChild(header);

        const row1 = document.createElement("div");
        row1.className = "row";

        const colMain = document.createElement("div");
        colMain.innerHTML = `
            <label>Hauptzahlen (x aus 50)</label>
            <select class="main-count"></select>
        `;
        const mainSelect = colMain.querySelector("select");
        for (let m = 5; m <= 11; m++) {
            const opt = document.createElement("option");
            opt.value = m.toString();
            opt.textContent = m.toString();
            mainSelect.appendChild(opt);
        }
        mainSelect.value = mainCount.toString();
        row1.appendChild(colMain);

        const colEuro = document.createElement("div");
        colEuro.innerHTML = `
            <label>Eurozahlen (x aus 12)</label>
            <select class="euro-count"></select>
        `;
        const euroSelect = colEuro.querySelector("select");
        row1.appendChild(colEuro);

        const colVariants = document.createElement("div");
        colVariants.innerHTML = `
            <label>Anzahl Varianten</label>
            <input class="variant-count" type="number" min="1" value="${variants}">
        `;
        row1.appendChild(colVariants);

        wrapper.appendChild(row1);

        const row2 = document.createElement("div");
        row2.className = "row";
        const colProfile = document.createElement("div");
        colProfile.innerHTML = `
            <label>Profil</label>
            <select class="profile-select">
                <option value="hot">üî• Hot-Fokus</option>
                <option value="cold">üßä Cold-Fokus</option>
                <option value="gap">‚è≥ Gap-Fokus</option>
                <option value="mix" selected>üéõÔ∏è Mix</option>
            </select>
        `;
        row2.appendChild(colProfile);

        const colInfo = document.createElement("div");
        colInfo.innerHTML = `
            <label>Spiele & Einsatz</label>
            <div class="small-note">
                Spiele: <span class="games">‚Äì</span>,
                Einsatz: <span class="price">‚Äì</span>
            </div>
        `;
        row2.appendChild(colInfo);

        wrapper.appendChild(row2);

        els.systemBlocks.appendChild(wrapper);

        function refreshEuroOptions() {
            const m = parseInt(mainSelect.value, 10);
            const allowed = getAllowedEuroCounts(m);
            euroSelect.innerHTML = "";
            allowed.forEach(e => {
                const opt = document.createElement("option");
                opt.value = e.toString();
                opt.textContent = e.toString();
                euroSelect.appendChild(opt);
            });
            if (allowed.includes(euroCount)) {
                euroSelect.value = euroCount.toString();
            }
        }

        mainSelect.addEventListener("change", () => {
            refreshEuroOptions();
            computeBlockGames(wrapper);
            updateTotals();
        });

        euroSelect.addEventListener("change", () => {
            computeBlockGames(wrapper);
            updateTotals();
        });

        colVariants.querySelector("input").addEventListener("input", () => {
            computeBlockGames(wrapper);
            updateTotals();
        });

        colProfile.querySelector("select").value = profile;

        refreshEuroOptions();
        computeBlockGames(wrapper);
        updateTotals();
    }

    function computeBlockGames(blockEl) {
        const main = parseInt(blockEl.querySelector(".main-count").value, 10);
        const euro = parseInt(blockEl.querySelector(".euro-count").value, 10);
        const variants = Math.max(1, parseInt(blockEl.querySelector(".variant-count").value || "1", 10));
        const gamesPerVariant = combinations(main, 5) * combinations(euro, 2);
        const gamesTotal = gamesPerVariant * variants;
        const priceTotal = gamesTotal * 2; // 2‚Ç¨ pro Spiel laut Systemspiel-Brosch√ºre

        blockEl.querySelector(".games").textContent = `${gamesTotal} (${gamesPerVariant} pro Variante)`;
        blockEl.querySelector(".price").textContent = formatEuro(priceTotal);
    }

    function updateTotals() {
        let totalGames = 0;
        let totalPrice = 0;
        const blocks = els.systemBlocks.querySelectorAll(".system-block");
        blocks.forEach(block => {
            const main = parseInt(block.querySelector(".main-count").value, 10);
            const euro = parseInt(block.querySelector(".euro-count").value, 10);
            const variants = Math.max(1, parseInt(block.querySelector(".variant-count").value || "1", 10));
            const gamesPerVariant = combinations(main, 5) * combinations(euro, 2);
            const gamesTotal = gamesPerVariant * variants;
            totalGames += gamesTotal;
            totalPrice += gamesTotal * 2;
        });
        els.totalGames.textContent = totalGames.toString();
        els.totalPrice.textContent = formatEuro(totalPrice);
    }

    // ----------------------------
    // Generator-Algorithmus
    // ----------------------------
    function generateSystemTips() {
        if (!state.stats || !state.filteredDraws.length) return;

        const blocks = Array.from(els.systemBlocks.querySelectorAll(".system-block"));
        if (!blocks.length) return;

        const s = state.stats;
        const maxMainFreq = Math.max(...s.mainFreq.slice(1));
        const maxEuroFreq = Math.max(...s.euroFreq.slice(1));
        const maxMainGap = Math.max(...s.mainLast.slice(1));
        const maxEuroGap = Math.max(...s.euroLast.slice(1));

        const usedMainCount = Array(51).fill(0);
        const usedEuroCount = Array(13).fill(0);

        const allTips = [];

        function scoreNumber(num, type, profile) {
            const freq = (type === "main") ? s.mainFreq[num] : s.euroFreq[num];
            const gap = (type === "main") ? s.mainLast[num] : s.euroLast[num];
            const maxF = (type === "main") ? maxMainFreq : maxEuroFreq;
            const maxG = (type === "main") ? maxMainGap : maxEuroGap;
            const hot = maxF > 0 ? (freq / maxF) : 0;
            const cold = 1 - hot;
            const gapRel = maxG > 0 ? (gap / maxG) : 0;

            let wHot=0, wCold=0, wGap=0;
            if (profile === "hot")      { wHot=0.7; wCold=0.1; wGap=0.2; }
            else if (profile === "cold"){ wHot=0.1; wCold=0.7; wGap=0.2; }
            else if (profile === "gap") { wHot=0.2; wCold=0.2; wGap=0.6; }
            else                        { wHot=0.4; wCold=0.2; wGap=0.4; }

            const base = wHot*hot + wCold*cold + wGap*gapRel;
            const usage = (type === "main") ? usedMainCount[num] : usedEuroCount[num];
            const penalty = 0.05 * usage;
            const noise = (Math.random() - 0.5) * 0.05;
            return base - penalty + noise;
        }

        blocks.forEach(block => {
            const mainCount = parseInt(block.querySelector(".main-count").value, 10);
            const euroCount = parseInt(block.querySelector(".euro-count").value, 10);
            const variants = Math.max(1, parseInt(block.querySelector(".variant-count").value || "1", 10));
            const profile = block.querySelector(".profile-select").value;

            for (let v = 0; v < variants; v++) {
                // Hauptzahlen ausw√§hlen
                const candMain = [];
                for (let n = 1; n <= 50; n++) {
                    candMain.push({n, score: scoreNumber(n, "main", profile)});
                }
                candMain.sort((a,b)=>b.score - a.score);
                const chosenMain = candMain.slice(0, mainCount).map(x=>x.n).sort((a,b)=>a-b);
                chosenMain.forEach(n => usedMainCount[n]++);

                // Eurozahlen ausw√§hlen
                const candEuro = [];
                for (let n = 1; n <= 12; n++) {
                    candEuro.push({n, score: scoreNumber(n, "euro", profile)});
                }
                candEuro.sort((a,b)=>b.score - a.score);
                const chosenEuro = candEuro.slice(0, euroCount).map(x=>x.n).sort((a,b)=>a-b);
                chosenEuro.forEach(n => usedEuroCount[n]++);

                const games = combinations(mainCount, 5) * combinations(euroCount, 2);
                const price = games * 2;

                allTips.push({
                    mainCount,
                    euroCount,
                    main: chosenMain,
                    euro: chosenEuro,
                    profile,
                    games,
                    price
                });
            }
        });

        renderSystemTips(allTips);
    }

    function renderSystemTips(tips) {
        if (!tips.length) {
            els.systemsOutput.style.display = "none";
            els.systemsOutput.innerHTML = "";
            return;
        }
        let html = "<table><thead><tr>" +
            "<th>#</th><th>System</th><th>Profil</th><th>Hauptzahlen</th><th>Eurozahlen</th><th>Spiele</th><th>Einsatz</th>" +
            "</tr></thead><tbody>";

        tips.forEach((tip, idx) => {
            const profileLabel = tip.profile === "hot" ? "üî• Hot"
                : tip.profile === "cold" ? "üßä Cold"
                : tip.profile === "gap" ? "‚è≥ Gap"
                : "üéõÔ∏è Mix";
            html += `<tr>
                <td>${idx+1}</td>
                <td>${tip.mainCount}/${tip.euroCount}</td>
                <td>${profileLabel}</td>
                <td class="tag-main">${tip.main.join(" ")}</td>
                <td class="tag-euro">${tip.euro.join(" ")}</td>
                <td>${tip.games}</td>
                <td>${formatEuro(tip.price)}</td>
            </tr>`;
        });

        html += "</tbody></table>";
        els.systemsOutput.innerHTML = html;
        els.systemsOutput.style.display = "block";
    }

    // ----------------------------
    // Tipp-Analyse
    // ----------------------------
    function analyzeTip() {
        const tipStr = els.analyzeInput.value.trim();
        const parsed = parseTipString(tipStr);
        if (!parsed) {
            els.analyzeResult.innerHTML = "<span class='small-note'>Format nicht erkannt. Beispiel: <code>5 12 23 34 45 | 2 10</code></span>";
            return;
        }
        if (!state.stats) return;
        const s = state.stats;

        function describe(arr, freq, last, label) {
            if (!arr.length) return "";
            let rows = arr.map(num => {
                const f = freq[num] || 0;
                const g = last[num] || (s.total + 1);
                return `<tr><td>${num}</td><td>${f}</td><td>${g}</td></tr>`;
            }).join("");
            return `
                <h4 style="margin:.4rem 0 .2rem;">${label}</h4>
                <table style="border-collapse:collapse;font-size:.8rem;width:100%;max-width:420px;">
                    <thead>
                        <tr>
                            <th style="border-bottom:1px solid #eee;padding:2px 4px;text-align:left;">Zahl</th>
                            <th style="border-bottom:1px solid #eee;padding:2px 4px;text-align:left;">H√§ufigkeit</th>
                            <th style="border-bottom:1px solid #eee;padding:2px 4px;text-align:left;">Abstand</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>`;
        }

        // Pr√ºfen, ob exakter 5+2 Tipp schon gezogen wurde
        let exactHits = 0;
        let dates = [];
        if (parsed.main.length === 5 && parsed.euro.length === 2) {
            const keyMain = parsed.main.join(",");
            const keyEuro = parsed.euro.join(",");
            state.filteredDraws.forEach(d => {
                if (d.main.slice().sort((a,b)=>a-b).join(",") === keyMain &&
                    d.euro.slice().sort((a,b)=>a-b).join(",") === keyEuro) {
                    exactHits++;
                    dates.push(d.date);
                }
            });
        }

        let headline = "";
        if (exactHits > 0) {
            headline = `<p class="small-note highlight">üéØ Dieser 5/2-Tipp ist bereits ${exactHits}√ó im ausgew√§hlten Zeitraum gefallen: ${dates.join(", ")}.</p>`;
        } else if (parsed.main.length === 5 && parsed.euro.length === 2) {
            headline = `<p class="small-note">‚ÑπÔ∏è Diese exakte 5/2-Kombination ist im ausgew√§hlten Zeitraum nicht vorgekommen.</p>`;
        } else {
            headline = `<p class="small-note">‚ÑπÔ∏è Systemtipp mit mehr als 5/2 Zahlen ‚Äì es wird die Einzelzahlen-Statistik angezeigt (keine exakten Systemtreffer).</p>`;
        }

        els.analyzeResult.innerHTML =
            headline +
            describe(parsed.main, s.mainFreq, s.mainLast, "Hauptzahlen") +
            describe(parsed.euro, s.euroFreq, s.euroLast, "Eurozahlen");
    }

    // ----------------------------
    // Event-Handler
    // ----------------------------
    els.scopeMode.addEventListener("change", () => {
        updateScope();
        computeStats();
        renderHotCold();
    });

    els.scopeLast.addEventListener("input", () => {
        if (els.scopeMode.value === "last") {
            updateScope();
            computeStats();
            renderHotCold();
        }
    });

    els.recalcBtn.addEventListener("click", () => {
        updateScope();
        computeStats();
        renderHotCold();
    });

    els.addBlockBtn.addEventListener("click", () => {
        addSystemBlock();
    });

    els.generateBtn.addEventListener("click", () => {
        updateTotals();
        generateSystemTips();
    });

    els.analyzeBtn.addEventListener("click", () => {
        analyzeTip();
    });

    // ----------------------------
    // Start
    // ----------------------------
    loadArchive();
</script>
</body>
</html>